{% extends "base.html" %}

{% block title %}数据分析 - 电商推荐系统{% endblock %}
{% block page_title %}数据分析{% endblock %}

{% block content %}
<!-- 统计概览 -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card stat-card primary h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-label">总用户数</div>
                        <div class="stat-value">{{ "{:,}".format(stats.total_users) }}</div>
                    </div>
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card stat-card success h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-label">总商品数</div>
                        <div class="stat-value">{{ "{:,}".format(stats.total_items) }}</div>
                    </div>
                    <div class="stat-icon"><i class="fas fa-box"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card stat-card info h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-label">总事件数</div>
                        <div class="stat-value">{{ "{:,}".format(stats.total_events) }}</div>
                    </div>
                    <div class="stat-icon"><i class="fas fa-mouse-pointer"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 转化漏斗 -->
    <div class="col-lg-6 mb-4">
        <div class="content-card h-100">
            <div class="card-header">
                <i class="fas fa-filter me-2"></i>用户转化漏斗
            </div>
            <div class="card-body">
                <div id="funnelChart" class="chart-container"></div>
            </div>
        </div>
    </div>
    
    <!-- 事件类型分布 -->
    <div class="col-lg-6 mb-4">
        <div class="content-card h-100">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>事件类型分布
            </div>
            <div class="card-body">
                <div id="eventChart" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 用户活跃度分布 -->
    <div class="col-lg-6 mb-4">
        <div class="content-card h-100">
            <div class="card-header">
                <i class="fas fa-user-clock me-2"></i>用户活跃度分布
            </div>
            <div class="card-body">
                <div id="activityChart" class="chart-container"></div>
            </div>
        </div>
    </div>
    
    <!-- 类目分布 -->
    <div class="col-lg-6 mb-4">
        <div class="content-card h-100">
            <div class="card-header">
                <i class="fas fa-tags me-2"></i>热门类目 TOP 15
            </div>
            <div class="card-body">
                <div id="categoryChart" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- 热门商品表格 -->
<div class="row">
    <div class="col-12">
        <div class="content-card">
            <div class="card-header">
                <i class="fas fa-fire me-2"></i>热门商品 TOP 20
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-custom table-hover mb-0">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>商品ID</th>
                                <th>类目</th>
                                <th>浏览次数</th>
                                <th>访客数</th>
                                <th>热度</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set max_views = hot_items[0].view_count if hot_items else 1 %}
                            {% for item in hot_items %}
                            <tr>
                                <td>
                                    <span class="badge {% if item.rank <= 3 %}bg-warning{% elif item.rank <= 10 %}bg-primary{% else %}bg-secondary{% endif %}">
                                        {{ item.rank }}
                                    </span>
                                </td>
                                <td><strong>{{ item.item_id }}</strong></td>
                                <td>{{ item.category_id }}</td>
                                <td>{{ "{:,}".format(item.view_count) }}</td>
                                <td>{{ "{:,}".format(item.unique_visitors) }}</td>
                                <td style="width: 200px;">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-primary" style="width: {{ (item.view_count / max_views * 100)|int }}%">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 转化漏斗图
    const funnelChart = echarts.init(document.getElementById('funnelChart'));
    const funnelData = [
        {% for f in funnel %}
        { value: {{ f.users }}, name: '{{ f.stage_cn }} ({{ f.rate }}%)' },
        {% endfor %}
    ];
    
    funnelChart.setOption({
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} 用户'
        },
        series: [{
            type: 'funnel',
            left: '10%',
            top: 20,
            bottom: 20,
            width: '80%',
            min: 0,
            minSize: '20%',
            maxSize: '100%',
            sort: 'descending',
            gap: 2,
            label: {
                show: true,
                position: 'inside',
                fontSize: 14
            },
            itemStyle: {
                borderColor: '#fff',
                borderWidth: 1
            },
            emphasis: {
                label: {
                    fontSize: 16
                }
            },
            data: funnelData,
            color: ['#4e73df', '#f6c23e', '#1cc88a']
        }]
    });
    
    // 事件分布饼图
    const eventChart = echarts.init(document.getElementById('eventChart'));
    eventChart.setOption({
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: false,
            itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
            },
            label: {
                show: true,
                formatter: '{b}\n{d}%'
            },
            data: [
                {% for e in event_dist %}
                { value: {{ e.count }}, name: '{{ e.event_type_cn }}' },
                {% endfor %}
            ],
            color: ['#4e73df', '#f6c23e', '#1cc88a']
        }]
    });
    
    // 用户活跃度分布
    const activityChart = echarts.init(document.getElementById('activityChart'));
    activityChart.setOption({
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} 用户 ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [{
            type: 'pie',
            radius: '70%',
            data: [
                {% for a in activity_dist %}
                { value: {{ a.count }}, name: '{{ a.level }}' },
                {% endfor %}
            ],
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            color: ['#1cc88a', '#4e73df', '#f6c23e', '#e74a3b']
        }]
    });
    
    // 类目分布柱状图
    const categoryChart = echarts.init(document.getElementById('categoryChart'));
    categoryChart.setOption({
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'value'
        },
        yAxis: {
            type: 'category',
            data: [{% for c in category_dist|reverse %}'类目{{ c.category_id }}',{% endfor %}],
            axisLabel: {
                fontSize: 10
            }
        },
        series: [{
            type: 'bar',
            data: [{% for c in category_dist|reverse %}{{ c.count }},{% endfor %}],
            itemStyle: {
                color: function(params) {
                    const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'];
                    return colors[params.dataIndex % colors.length];
                }
            }
        }]
    });
    
    // 响应式
    window.addEventListener('resize', function() {
        funnelChart.resize();
        eventChart.resize();
        activityChart.resize();
        categoryChart.resize();
    });
</script>
{% endblock %}
