# 推荐策略说明文档

## 问题分析

### 用户反馈的问题
当用户历史浏览记录都是同一个类目（如类目1434）时，推荐结果却包含各种不同类目的商品，没有体现用户对该类目的偏好。

### 根本原因
**这是ALS协同过滤模型的固有特性，不是bug**。

#### ALS模型的工作原理
- **协同过滤（Collaborative Filtering）**：基于"相似用户喜欢相似商品"的假设
- **只学习用户-商品交互模式**：不考虑商品的内容特征（类目、品牌、价格等）
- **推荐逻辑**：如果很多浏览类目A的用户也喜欢类目B的商品，那么即使你只浏览了类目A，模型也会推荐类目B

#### 举例说明
```
用户群体行为模式：
- 用户1: 浏览类目1434 → 购买类目1205
- 用户2: 浏览类目1434 → 购买类目1650  
- 用户3: 浏览类目1434 → 购买类目683

当前用户: 浏览类目1434
ALS推荐: 类目1205、1650、683（因为相似用户有这样的购买模式）
```

这种推荐有其合理性：**帮助用户发现潜在需求**（跨品类推荐）

---

## 解决方案

### 方案1：混合推荐（协同过滤 + 类目加权）✅ 已实现

**文件**：`spark/recommend_hybrid.py`

**策略**：
1. 使用ALS生成50个候选推荐
2. 统计用户历史浏览的类目偏好（带权重：浏览×1，加购×3，购买×5）
3. 对偏好类目商品的推荐分数 × 1.5
4. 重新排序，取Top 10

**优点**：
- ✅ 提升偏好类目的排名
- ✅ 保留跨类目推荐（探索性）
- ✅ 平衡个性化和多样性

**使用方法**：
```bash
# 指定用户
spark-submit spark/recommend_hybrid.py 257597

# 随机用户
spark-submit spark/recommend_hybrid.py
```

---

### 方案2：类目过滤推荐（强约束）🆕 推荐

**策略**：
1. 统计用户Top 3偏好类目
2. 从ALS候选推荐中，**优先**选择偏好类目的商品
3. 如果偏好类目商品不足10个，再补充其他类目

**优点**：
- ✅ 强化类目个性化
- ✅ 确保大部分推荐来自用户感兴趣的类目
- ✅ 适合垂直电商场景

**缺点**：
- ⚠️ 可能降低推荐多样性
- ⚠️ 减少用户发现新品类的机会

**实现方案**：

创建 `spark/recommend_category_filtered.py`：
```python
# 伪代码
user_prefer_categories = get_top_3_categories(user_id)  # 类目1434
als_candidates = als_model.recommend(user_id, 50)

# 优先选择偏好类目
preferred_recs = [r for r in als_candidates if r.category in user_prefer_categories][:7]
other_recs = [r for r in als_candidates if r.category not in user_prefer_categories][:3]

final_recs = preferred_recs + other_recs  # 7个偏好类目 + 3个探索类目
```

---

### 方案3：基于内容的推荐（纯类目相似）

**策略**：
- 完全基于类目相似度推荐
- 用户浏览类目1434 → 只推荐类目1434的商品

**优点**：
- ✅ 100%符合用户当前兴趣

**缺点**：
- ❌ 缺乏个性化（所有浏览该类目的用户推荐都一样）
- ❌ 没有利用ALS模型
- ❌ 容易推荐用户已浏览过的商品

---

## 推荐策略对比

| 策略 | 个性化 | 类目相关性 | 多样性 | 探索性 | 适用场景 |
|------|--------|-----------|--------|--------|---------|
| **纯ALS** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 综合电商 |
| **混合推荐** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | **最佳平衡** |
| **类目过滤** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐ | 垂直电商 |
| **纯类目** | ⭐ | ⭐⭐⭐⭐⭐ | ⭐ | ⭐ | 简单场景 |

---

## 建议

### 当前推荐：方案1（混合推荐）✅

已实现在 `spark/recommend_hybrid.py`，效果示例：
```
【用户类目偏好】
  1. 类目1228  浏览 24次  权重 24
  2. 类目1085  浏览 12次  权重 12
  3. 类目5     浏览  3次  权重  3

【推荐结果】
  排名  商品ID   商品类目    基础分   加权分   标记
  1    43725   类目5      0.1314   0.1972  ★偏好类目  <- 加权后排名提升
  2    244252  类目1205   0.1895   0.1895
  ...
```

### 进阶选择：方案2（类目过滤）

如果需要**更强的类目约束**，可以实现方案2，确保70%推荐来自用户偏好类目。

---

## 技术细节

### ALS模型参数（当前配置）
```python
als = ALS(
    rank=80,              # 隐因子维度
    maxIter=25,           # 迭代次数
    regParam=0.005,       # 正则化参数
    alpha=5.0,            # 隐式反馈置信权重
    implicitPrefs=True    # 隐式反馈模式
)
```

### 为什么不修改ALS模型本身？

1. **ALS不支持特征输入**：ALS只能接受user_id、item_id、rating三列，无法输入类目等特征
2. **需要其他模型**：要在模型层面融合内容特征，需要用：
   - Wide & Deep 模型
   - DeepFM
   - Neural Collaborative Filtering (NCF)
3. **成本高**：需要重新设计模型架构、特征工程、训练流程

### 混合推荐的优势

在**后处理阶段**加权/过滤，成本低、效果好、易调整！

---

## 使用指南

### 测试混合推荐
```bash
# 随机用户
spark-submit spark/recommend_hybrid.py

# 指定用户
spark-submit spark/recommend_hybrid.py 257597
```

### 查看效果
推荐结果会显示：
- 【用户类目偏好】：Top 5 偏好类目
- 【推荐结果】：标记 ★偏好类目
- 【推荐质量评估】：偏好类目命中率
- 【对比】：纯ALS vs 混合推荐的差异

---

## Q&A

**Q: 为什么偏好类目命中率还是很低？**
A: 可能原因：
1. 用户历史交互太少，偏好不明显
2. 加权系数（1.5）太小，可以调整为2.0或更高
3. 数据集中该类目的热门商品少
4. 可以改用方案2（类目过滤）强制提高命中率

**Q: 怎么调整加权系数？**
A: 修改 `recommend_hybrid.py` 第124行：
```python
weighted_score = base_score * 2.0  # 改为2.0或更高
```

**Q: 能否完全只推荐用户偏好类目？**
A: 可以，但不推荐。这会：
- 降低推荐多样性
- 失去ALS的优势（发现潜在兴趣）
- 如果确实需要，用方案2（类目过滤）并设置比例为10:0

---

## 总结

✅ **问题根源**：ALS协同过滤模型不考虑类目特征（这是设计特点，不是缺陷）

✅ **解决方案**：混合推荐（ALS + 类目加权）已实现

✅ **效果**：平衡个性化和多样性，提升类目相关性

✅ **下一步**：根据业务需求，可选择更激进的类目过滤策略
